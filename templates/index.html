<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Ç–æ–ø–ª–∏–≤–æ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card {
            margin-bottom: 20px;
        }
        .status-badge {
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">üìä –°–∏—Å—Ç–µ–º–∞ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —Ç–æ–ø–ª–∏–≤–æ–æ–±–µ—Å–ø–µ—á–µ–Ω–∏—é</h1>
        
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª (.xlsx)</label>
                                <input class="form-control" type="file" id="fileInput" accept=".xlsx" required>
                                <div class="form-text">–§–∞–π–ª –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç—á–µ—Ç–æ–≤</div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
                            </button>
                        </form>
                        <div id="uploadStatus" class="mt-3"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="reportDate" class="form-label">–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞</label>
                            <input type="date" class="form-control" id="reportDate" 
                                   value="{{ now.strftime('%Y-%m-%d') }}">
                                   <form action="/generate-report" method="GET">
                                        <button id="generateReportBtn" class="btn btn-success w-100">
                                            üóÇÔ∏è –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–¥–Ω—ã–π –æ—Ç—á–µ—Ç
                                        </button>
                                    </form>
                        </div>

                            <form action="/generate-template-fixed" method="GET">
                                <div class="form-group">
                                    <label for="template_report_date">–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:</label>
                                    <input type="date" id="template_report_date" name="report_date" 
                                        value="{{ now.strftime('%Y-%m-%d') }}" class="form-control">
                                </div>
                                
                                <div class="button-group">
                                    <button type="submit" class="btn btn-success w-100">
                                        üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç –ø–æ —à–∞–±–ª–æ–Ω—É(update)
                                    </button>
                                </div>
                            </form>
                    
                        <div id="reportStatus" class="mt-3"></div>
                    
                            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω Excel –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞.</p>
                            
                            <form action="/generate-template-report" method="GET">
                                <div class="form-group">
                                    <label for="template_report_date">–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:</label>
                                    <input type="date" id="template_report_date" name="report_date" 
                                        value="{{ now.strftime('%Y-%m-%d') }}" class="form-control">
                                </div>
                                
                                <div class="button-group">
                                    <button type="submit" class="btn btn-success w-100">
                                        üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç –ø–æ —à–∞–±–ª–æ–Ω—É
                                    </button>
                                </div>
                            </form>

                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω–∞ "–°–≤–æ–¥–Ω—ã–π_–æ—Ç—á–µ—Ç_—à–∞–±–ª–æ–Ω.xlsx" 
                                    –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–∞–ø–∫–µ report_templates
                                </small>
                            </div>
                        </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-check"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
                            <span class="badge bg-secondary float-end">{{ recent_files|length }}</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if recent_files %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>‚Ññ</th>
                                        <th>–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞</th>
                                        <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞</th>
                                        <th>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for file in recent_files %}
                                    <tr>
                                        <td>{{ loop.index }}</td>
                                        <td>
                                            {% if file.report_date %}
                                                {{ file.report_date.strftime('%d.%m.%Y') }}
                                            {% else %}
                                                <span class="text-muted">–ù/–î</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>{{ file.company_name }}</strong>
                                            {% if file.company_code %}
                                                <br><small class="text-muted">{{ file.company_code }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-monospace">{{ file.filename|truncate(30) }}</small>
                                            {% if file.filename|length > 30 %}
                                                <br><small class="text-muted" title="{{ file.filename }}">...{{ file.filename[-20:] }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>
                                                {% if file.upload_date %}
                                                    {{ file.upload_date.strftime('%d.%m.%Y') }}<br>
                                                    {{ file.upload_date.strftime('%H:%M:%S') }}
                                                {% else %}
                                                    <span class="text-muted">–ù/–î</span>
                                                {% endif %}
                                            </small>
                                        </td>
                                        <td>
                                            {% if file.status == 'processed' %}
                                                <span class="badge bg-success status-badge" title="–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã">
                                                    ‚úì –û–±—Ä–∞–±–æ—Ç–∞–Ω
                                                </span>
                                            {% elif file.status == 'error' %}
                                                <span class="badge bg-danger status-badge" title="–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ">
                                                    ‚úó –û—à–∏–±–∫–∞
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning status-badge" title="–í –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏">
                                                    ‚è≥ {{ file.status or '–ó–∞–≥—Ä—É–∂–µ–Ω' }}
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info text-center">
                            <i class="bi bi-inbox"></i> –§–∞–π–ª—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                            <p class="mb-0 mt-2"><small>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º—É —Å–ª–µ–≤–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Excel —Ñ–∞–π–ª–æ–≤</small></p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">üè¢ –ö–æ–º–ø–∞–Ω–∏–∏ –≤ —Å–∏—Å—Ç–µ–º–µ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for company in companies %}
                            <div class="col-md-4 mb-3">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <h6 class="card-title">{{ company.name }}</h6>
                                        <small class="text-muted">{{ company.code }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –í templates/index.html –∏—Å–ø—Ä–∞–≤–ª—è–µ–º JavaScript —á–∞—Å—Ç—å -->
<script>
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileInput');
        const statusDiv = document.getElementById('uploadStatus');
        
        if (!fileInput.files[0]) {
            statusDiv.innerHTML = '<div class="alert alert-danger">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</div>';
            return;
        }
        
        statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</div>';
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        
        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // –ò–°–ü–†–ê–í–õ–Ø–ï–ú –≠–¢–£ –ß–ê–°–¢–¨:
                const dataExtracted = result.data_extracted || {};
                
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!
                        <p><strong>–ö–æ–º–ø–∞–Ω–∏—è:</strong> ${result.company || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–î–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞:</strong> ${result.report_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        ${dataExtracted.sheet1 !== undefined ? `
                        <p><strong>–ò–∑–≤–ª–µ—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö:</strong></p>
                        <ul class="mb-0">
                            <li>–õ–∏—Å—Ç 1: ${dataExtracted.sheet1 || 0} –∑–∞–ø–∏—Å–µ–π</li>
                            <li>–õ–∏—Å—Ç 2: ${dataExtracted.sheet2 ? '–¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å' : '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</li>
                            <li>–õ–∏—Å—Ç 3: ${dataExtracted.sheet3 || 0} –∑–∞–ø–∏—Å–µ–π</li>
                            <li>–õ–∏—Å—Ç 5: ${dataExtracted.sheet5 || 0} –∑–∞–ø–∏—Å–µ–π</li>
                        </ul>
                        ` : ''}
                    </div>
                `;
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
                setTimeout(() => location.reload(), 3000);
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                        ${result.details ? '<details><summary>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</summary><pre>' + result.details + '</pre></details>' : ''}
                    </div>
                `;
            }
        } catch (error) {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}
                </div>
            `;
        }
        
        fileInput.value = '';
    });
    
    document.getElementById('reportForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const dateInput = document.getElementById('report_date').value;
        
        fetch('/generate-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                report_date: dateInput
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                window.location.href = data.download_url;
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞');
        });
    });

    // –¢–∞–∫–∂–µ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –≤—Ç–æ—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    document.getElementById('generateReportBtn').addEventListener('click', async function() {
        const reportDate = document.getElementById('reportDate').value;
        const statusDiv = document.getElementById('reportStatus');
        
        statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞...</div>';
        
        try {
            const response = await fetch('/generate-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ report_date: reportDate })
            });
            
            const result = await response.json();
            
            if (result.success) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        ‚úÖ –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!
                        <p><strong>–§–∞–π–ª:</strong> ${result.filename || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <a href="/download-report/${result.filename || ''}" class="btn btn-sm btn-success mt-2">
                            üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
                        </a>
                    </div>
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ‚ùå –û—à–∏–±–∫–∞: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                        ${result.details ? '<details><summary>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</summary><pre>' + result.details + '</pre></details>' : ''}
                    </div>
                `;
            }
        } catch (error) {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}
                </div>
            `;
        }
    });
</script>
</body>
</html>